<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictive Purchase Outcome Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f0f2f5; /* New light gray background */
            background-image:
                radial-gradient(at 0% 0%, hsla(243, 89%, 70%, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(343, 89%, 70%, 0.1) 0px, transparent 50%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Custom animations for enhanced UI/UX */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounceIn {
            0%, 20%, 40%, 60%, 80%, 100% {
                transition-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
            }
            0% { opacity: 0; transform: scale3d(.3, .3, .3); }
            20% { transform: scale3d(1.1, 1.1, 1.1); }
            40% { transform: scale3d(.9, .9, .9); }
            60% { opacity: 1; transform: scale3d(1.03, 1.03, 1.03); }
            80% { transform: scale3d(.97, .97, .97); }
            100% { opacity: 1; transform: scale3d(1, 1, 1); }
        }
        .animate-fade-in-down { animation: fadeInDown 1s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 1s ease-out forwards; }
        .animate-bounce-in { animation: bounceIn 1s ease-out forwards; }

        /* Animation for new table rows */
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-in-from-bottom {
            animation: slideInFromBottom 0.5s ease-out forwards;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Button styling - consistent with e-commerce site */
        .button-primary {
            background-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .button-primary:hover {
            background-color: #4338ca; /* indigo-700 */
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -2px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
        }
        .button-primary:active {
            transform: translateY(0);
            box-shadow: none;
        }
        /* Disable state for primary button */
        .button-primary:disabled {
            background-color: #9fa6b2; /* gray-400 */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .button-secondary {
            border: 1px solid #d1d5db; /* gray-300 */
            background-color: #ffffff; /* bg-white */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            color: #4b5563; /* gray-700 */
        }
        .button-secondary:hover {
            background-color: #f3f4f6; /* gray-100 */
            transform: translateY(-1px);
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.08);
        }
        .button-secondary:active {
            transform: translateY(0);
            box-shadow: none;
        }
        /* Disable state for secondary button */
        .button-secondary:disabled {
            background-color: #e5e7eb; /* gray-200 */
            color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Message area styling - consistent with e-commerce site */
        .message-box {
            padding: 10px 15px;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-10px);
            animation: fadeSlideIn 0.5s forwards;
            display: flex; /* Added for icon alignment */
            align-items: center; /* Added for icon alignment */
            justify-content: center; /* Center content horizontally */
        }
        .message-box.success {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
            border: 1px solid #34d399; /* green-400 */
        }
        .message-box.error {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            border: 1px solid #f87171; /* red-400 */
        }
        .message-box.info {
            background-color: #e0f2fe; /* blue-100 */
            color: #1e40af; /* blue-800 */
            border: 1px solid #60a5fa; /* blue-400 */
        }
        .message-box.warning { /* Added for exchange status */
            background-color: #fffbe6; /* yellow-100 */
            color: #92400e; /* yellow-800 */
            border: 1px solid #fcd34d; /* yellow-400 */
        }
        .message-box svg {
            margin-right: 0.5rem; /* Space between icon and text */
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scroll to Top Button */
        .scroll-to-top-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            padding: 0.75rem;
            border-radius: 9999px; /* fully rounded */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0; /* Hidden by default */
            pointer-events: none; /* Prevents interaction when hidden */
            z-index: 1000; /* Ensure it's on top */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scroll-to-top-btn.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        .scroll-to-top-btn:hover {
            background-color: #4338ca; /* indigo-700 */
            transform: translateY(-3px);
        }
        .scroll-to-top-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Table styling */
        .styled-table {
            width: 100%;
            border-collapse: separate; /* Allows border-radius on cells */
            border-spacing: 0; /* Remove default spacing */
            overflow: hidden; /* Ensures rounded corners are visible */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .styled-table thead th {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer; /* Indicate sortable columns */
            transition: background-color 0.2s ease-in-out;
        }
        .styled-table thead th:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .styled-table thead th.sorted-asc::after {
            content: " ▲";
        }
        .styled-table thead th.sorted-desc::after {
            content: " ▼";
        }

        .styled-table tbody tr {
            background-color: #ffffff;
            transition: background-color 0.2s ease-in-out;
        }
        .styled-table tbody tr:nth-child(even) {
            background-color: #f3f4f6; /* gray-100 */
        }
        .styled-table tbody tr:hover {
            background-color: #e0e7ff; /* indigo-100 */
        }
        .styled-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
            font-size: 0.9375rem; /* ~15px */
        }
        .styled-table tbody tr:last-child td {
            border-bottom: none;
        }
        .styled-table thead th:first-child { border-top-left-radius: 0.5rem; }
        .styled-table thead th:last-child { border-top-right-radius: 0.5rem; }
        .styled-table tbody tr:last-child td:first-child { border-bottom-left-radius: 0.5rem; }
        .styled-table tbody tr:last-child td:last-child { border-bottom-right-radius: 0.5rem; }

        /* Specific styling for outcome cells */
        .outcome-keep { color: #10b981; font-weight: 600; } /* green-500 */
        .outcome-exchange { color: #f59e0b; font-weight: 600; } /* yellow-500 */
        .outcome-refund { color: #ef4444; font-weight: 600; } /* red-500 */

        /* Responsive table behavior */
        @media (max-width: 768px) {
            .styled-table thead {
                display: none; /* Hide table headers on small screens */
            }
            .styled-table, .styled-table tbody, .styled-table tr, .styled-table td {
                display: block; /* Make table elements behave like block elements */
                width: 100%;
            }
            .styled-table tr {
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                overflow: hidden;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            }
            .styled-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                border-bottom: 1px dashed #e5e7eb;
            }
            .styled-table td:last-child {
                border-bottom: none;
            }
            .styled-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 50%;
                padding-left: 1rem;
                font-weight: 600;
                text-align: left;
                color: #4b5563;
            }
        }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the element */
            left: 50%;
            margin-left: -100px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%; /* At the bottom of the tooltip */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Pulse animation for button */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
            }
        }
        .animate-pulse-on-hover:hover {
            animation: pulse 1s infinite;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Dark semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Above all other content */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem; /* More padding for a premium feel */
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2), 0 4px 10px rgba(0, 0, 0, 0.15); /* Stronger shadow */
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-header {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* gray-900 */
            margin-bottom: 1.5rem; /* mb-6 */
            text-align: center;
        }
        .modal-label {
            display: block;
            font-size: 1rem; /* text-base */
            font-weight: 600; /* font-semibold */
            color: #374151; /* gray-700 */
            margin-bottom: 0.5rem;
        }
        .modal-input {
            width: 100%;
            padding: 0.75rem; /* py-3 */
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .modal-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
            outline: none;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        .modal-message {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .modal-message.success { color: #065f46; }
        .modal-message.error { color: #991b1b; }

        /* Styles for product suggestions dropdown (generalized for re-use) */
        .product-suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            width: 100%; /* Match width of the input */
            margin-top: 0.25rem; /* Space between input and suggestions */
        }

        .product-suggestions div {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .product-suggestions div:hover {
            background-color: #e0e7ff; /* indigo-100 */
        }

        .product-input-container {
            position: relative; /* Needed for absolute positioning of suggestions */
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 flex flex-col min-h-screen">
    <section class="relative bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-20 lg:py-24 overflow-hidden rounded-b-lg shadow-lg mx-auto w-full mb-12">
        <div class="container mx-auto text-center px-4">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight mb-6 animate-fade-in-down">
                Predictive Purchase Outcome Simulator
            </h1>
            <p class="text-lg sm:text-xl mb-8 opacity-90 animate-fade-in-up">
                Understand and predict customer purchase outcomes (Keep, Exchange, Refund).
            </p>
            <a href="#prediction-input-section" class="inline-block bg-white text-indigo-700 hover:bg-gray-100 px-8 py-3 rounded-full text-lg font-semibold shadow-lg transition-all duration-300 transform hover:scale-105 animate-bounce-in smooth-scroll relative z-10 animate-pulse-on-hover">
                Start Simulating
            </a>
        </div>
        <div class="absolute inset-0 z-0 opacity-20">
            <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="20" cy="20" r="15" fill="url(#gradient1)" opacity="0.6">
                    <animate attributeName="cx" values="20;80;20" dur="10s" repeatCount="indefinite" />
                    <animate attributeName="cy" values="20;80;20" dur="12s" repeatCount="indefinite" />
                </circle>
                <circle cx="80" cy="80" r="20" fill="url(#gradient2)" opacity="0.5">
                    <animate attributeName="cx" values="80;20;80" dur="11s" repeatCount="indefinite" />
                    <animate attributeName="cy" values="80;20;80" dur="13s" repeatCount="indefinite" />
                </circle>
                <circle cx="50" cy="50" r="10" fill="url(#gradient3)" opacity="0.7">
                    <animate attributeName="cx" values="50;10;90;50" dur="15s" repeatCount="indefinite" />
                    <animate attributeName="cy" values="50;90;10;50" dur="14s" repeatCount="indefinite" />
                </circle>
                <defs>
                    <radialGradient id="gradient1" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(20 20) scale(30)">
                        <stop stop-color="#fff" stop-opacity="0.8"/>
                        <stop offset="1" stop-color="#fff" stop-opacity="0"/>
                    </radialGradient>
                    <radialGradient id="gradient2" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(80 80) scale(40)">
                        <stop stop-color="#fff" stop-opacity="0.7"/>
                        <stop offset="1" stop-color="#fff" stop-opacity="0"/>
                    </radialGradient>
                    <radialGradient id="gradient3" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(50 50) scale(20)">
                        <stop stop-color="#fff" stop-opacity="0.9"/>
                        <stop offset="1" stop-color="#fff" stop-opacity="0"/>
                    </radialGradient>
                </defs>
            </svg>
        </div>
    </section>

    <main class="flex-grow container mx-auto px-4 py-8">
        <section id="prediction-input-section" class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-12 max-w-4xl mx-auto animate-fade-in-up">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Simulate Purchase & Predict Outcome</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="product-input-container md:col-span-1">
                    <label for="productNameInput" class="block text-base font-semibold text-gray-700 mb-2">Product Name</label>
                    <input type="text" id="productNameInput"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base transition duration-200 ease-in-out"
                           placeholder="Type or click to select a product">
                    <div id="productSuggestions" class="product-suggestions hidden"></div>
                </div>
                <div class="product-input-container">
                    <label for="shoppingChannelInput" class="block text-base font-semibold text-gray-700 mb-2">Shopping Channel</label>
                    <input type="text" id="shoppingChannelInput"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base transition duration-200 ease-in-out"
                           placeholder="Type or click to select a channel">
                    <div id="shoppingChannelSuggestions" class="product-suggestions hidden"></div>
                </div>
                <div class="product-input-container md:col-span-2">
                    <label for="simulateActualStatusInput" class="block text-base font-semibold text-gray-700 mb-2">
                        Simulate Actual Status
                        <span class="tooltip-container">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block ml-1 text-gray-400">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                            <span class="tooltip-text">For demo purposes, select the actual outcome to compare with the model's prediction.</span>
                        </span>
                    </label>
                    <input type="text" id="simulateActualStatusInput"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base transition duration-200 ease-in-out"
                           placeholder="Type or click to select status">
                    <div id="simulateActualStatusSuggestions" class="product-suggestions hidden"></div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-center gap-5 mb-6">
                <button id="predictOutcomeBtn"
                        class="button-primary flex items-center justify-center px-8 py-3 text-lg font-medium rounded-lg text-white focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    <span id="predictButtonText">Predict Outcome</span>
                    <div id="predictLoadingSpinner" class="spinner ml-3 hidden"></div>
                </button>
                <button id="clearFormBtn"
                        class="button-secondary px-8 py-3 text-lg font-medium rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200">
                    Clear Form
                </button>
                <button id="bulkPredictBtn"
                        class="button-secondary px-8 py-3 text-lg font-medium rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200">
                    Bulk Predict
                </button>
            </div>

            <div id="predictionResultArea" class="text-center text-lg font-semibold mb-4 min-h-[30px]"></div>

            <div class="flex justify-center">
                <button id="addToHistoryBtn"
                        class="button-secondary px-6 py-2 text-base font-medium rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200 hidden">
                    Add to History
                </button>
            </div>
        </section>

        <!-- NEW Tactical Metrics Section -->
        <section id="metrics-dashboard" class="mb-12 max-w-full mx-auto hidden animate-fade-in-up">
             <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Performance Dashboard</h2>
             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                 <!-- Total Simulations Card -->
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                     <div>
                         <p class="text-sm font-medium text-gray-500">Total Simulations</p>
                         <p id="totalSimulations" class="text-3xl font-bold text-gray-800">0</p>
                     </div>
                     <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full">
                         <i class="ri-play-list-add-line text-2xl"></i>
                     </div>
                 </div>
                 <!-- Model Accuracy Card -->
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                     <div>
                         <p class="text-sm font-medium text-gray-500">Model Accuracy</p>
                         <p id="modelAccuracy" class="text-3xl font-bold text-gray-800">0%</p>
                     </div>
                     <div class="bg-green-100 text-green-600 p-3 rounded-full">
                         <i class="ri-check-double-line text-2xl"></i>
                     </div>
                 </div>
                 <!-- Keep Rate Card -->
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                     <div>
                         <p class="text-sm font-medium text-gray-500">Predicted "Keep" Rate</p>
                         <p id="keepRate" class="text-3xl font-bold text-gray-800">0%</p>
                     </div>
                     <div class="bg-blue-100 text-blue-600 p-3 rounded-full">
                         <i class="ri-thumb-up-line text-2xl"></i>
                     </div>
                 </div>
                 <!-- Refund/Exchange Rate Card -->
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                     <div>
                         <p class="text-sm font-medium text-gray-500">Predicted "Action" Rate</p>
                         <p id="actionRate" class="text-3xl font-bold text-gray-800">0%</p>
                     </div>
                     <div class="bg-red-100 text-red-600 p-3 rounded-full">
                         <i class="ri-alert-line text-2xl"></i>
                     </div>
                 </div>
             </div>
        </section>

        <section id="history-dashboard" class="bg-white p-6 sm:p-8 rounded-xl shadow-md max-w-full mx-auto overflow-x-auto animate-fade-in-up">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Purchase History & Model Performance</h2>

            <div class="mb-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-2">
                    <label for="sortColumn" class="text-gray-700 font-medium">Sort by:</label>
                    <select id="sortColumn" class="px-3 py-1 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option value="time">Time</option>
                        <option value="productName">Product</option>
                        <option value="actualStatus">Actual Outcome</option>
                        <option value="predictedOutcome">Predicted Outcome</option>
                    </select>
                    <button id="sortOrderBtn" class="p-1 rounded-md hover:bg-gray-200 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-gray-600">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v9.75m0 0-3-3m3 3 3-3" />
                        </svg>
                    </button>
                </div>
                <div class="flex gap-4">
                    <button id="clearFiltersBtn"
                            class="button-secondary px-6 py-2 text-base font-medium rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200">
                        Clear Filters
                    </button>
                    <button id="clearHistoryBtn"
                            class="button-secondary px-6 py-2 text-base font-medium rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200">
                        Clear History
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th data-column="customerId">Customer ID</th>
                            <th data-column="time" class="sorted-desc">Time</th>
                            <th data-column="productName">Product</th>
                            <th data-column="shoppingChannel">Channel</th>
                            <th data-column="actualStatus">Actual Outcome</th>
                            <th data-column="predictedOutcome">Predicted Outcome</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr><td colspan="6" class="text-center text-gray-500 py-4">No purchases yet. Simulate one above!</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="chart-section" class="bg-white p-6 sm:p-8 rounded-xl shadow-md max-w-full mx-auto mt-8 hidden animate-fade-in-up">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Outcome Comparison Chart</h2>
            <div class="relative h-96">
                <canvas id="outcomeChart"></canvas>
            </div>
        </section>
    </main>

    <footer class="bg-gray-900 text-gray-300 py-8 px-4 mt-12">
        <div class="container mx-auto text-center">
            <h3 class="text-xl font-bold mb-2 text-white">Predictive Model Simulator</h3>
            <p class="text-gray-400 text-sm">&copy; 2024 YourCompany. All rights reserved.</p>
            <div class="flex justify-center space-x-4 mt-4">
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-200">Privacy Policy</a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-200">Terms of Service</a>
            </div>
        </div>
    </footer>

    <button id="scrollToTopBtn" class="scroll-to-top-btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" />
        </svg>
    </button>

    <!-- Bulk Predict Modal -->
    <div id="bulkPredictModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-header">Bulk Prediction Entries</h2>
            <div class="mb-6">
                <label for="numBulkEntries" class="modal-label">Number of entries to generate:</label>
                <input type="number" id="numBulkEntries" min="1" value="10"
                       class="modal-input">
            </div>
            <div id="bulkPredictMessageArea" class="modal-message"></div>
            <div class="modal-buttons">
                <button id="generateBulkBtn" class="button-primary flex items-center px-6 py-3 text-lg font-medium rounded-lg text-white focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    <span id="generateBulkButtonText">Generate & Add to History</span>
                    <div id="generateBulkLoadingSpinner" class="spinner ml-3 hidden"></div>
                </button>
                <button id="closeBulkModalBtn" class="button-secondary px-6 py-3 text-lg font-medium rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const BACKEND_URL = "http://127.0.0.1:8000"; // Your FastAPI backend URL

        // --- DOM Element References ---
        const productNameInput = document.getElementById('productNameInput');
        const productSuggestionsDiv = document.getElementById('productSuggestions');
        const shoppingChannelInput = document.getElementById('shoppingChannelInput');
        const shoppingChannelSuggestionsDiv = document.getElementById('shoppingChannelSuggestions');
        const simulateActualStatusInput = document.getElementById('simulateActualStatusInput');
        const simulateActualStatusSuggestionsDiv = document.getElementById('simulateActualStatusSuggestions');

        const predictOutcomeBtn = document.getElementById('predictOutcomeBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const predictionResultArea = document.getElementById('predictionResultArea');
        const predictButtonText = document.getElementById('predictButtonText');
        const predictLoadingSpinner = document.getElementById('predictLoadingSpinner');
        const addToHistoryBtn = document.getElementById('addToHistoryBtn');
        const historyTableBody = document.getElementById('historyTableBody');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const startSimulatingBtn = document.querySelector('.smooth-scroll');
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');
        const sortColumnSelect = document.getElementById('sortColumn');
        const sortOrderBtn = document.getElementById('sortOrderBtn');
        const tableHeaders = document.querySelectorAll('.styled-table thead th[data-column]');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');

        const bulkPredictBtn = document.getElementById('bulkPredictBtn');
        const bulkPredictModal = document.getElementById('bulkPredictModal');
        const numBulkEntriesInput = document.getElementById('numBulkEntries');
        const generateBulkBtn = document.getElementById('generateBulkBtn');
        const closeBulkModalBtn = document.getElementById('closeBulkModalBtn');
        const bulkPredictMessageArea = document.getElementById('bulkPredictMessageArea');
        const generateBulkButtonText = document.getElementById('generateBulkButtonText');
        const generateBulkLoadingSpinner = document.getElementById('generateBulkLoadingSpinner');

        // New Metrics Dashboard elements
        const metricsDashboard = document.getElementById('metrics-dashboard');
        const totalSimulationsEl = document.getElementById('totalSimulations');
        const modelAccuracyEl = document.getElementById('modelAccuracy');
        const keepRateEl = document.getElementById('keepRate');
        const actionRateEl = document.getElementById('actionRate');


        const outcomeChartCanvas = document.getElementById('outcomeChart');
        let outcomeChartInstance = null;

        // --- Data Arrays (will be populated from backend) ---
        let productOptions = [];
        let channelOptions = [];
        const possibleOutcomes = ['Keep', 'Exchange', 'Refund'];

        // --- Global State ---
        let purchaseHistory = [];
        let currentSortColumn = 'time';
        let currentSortOrder = 'desc';

        // --- Helper Functions ---

        function showMessage(targetArea, message, type = 'info') {
            targetArea.innerHTML = '';
            const msgDiv = document.createElement('div');
            let iconSvg = '';
            if (type === 'success') {
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline-block mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0118 0Z" /></svg>`;
            } else if (type === 'error') {
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline-block mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0118 0Z" /></svg>`;
            } else if (type === 'warning') {
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline-block mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.174 3.35 1.94 3.35h14.72c1.766 0 2.806-1.85 1.94-3.35L12 2.25 2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>`;
            } else {
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline-block mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0118 0Z" /></svg>`;
            }
            msgDiv.innerHTML = `${iconSvg}<span>${message}</span>`;
            msgDiv.className = `message-box ${type}`;
            targetArea.appendChild(msgDiv);
            setTimeout(() => {
                if (targetArea.contains(msgDiv)) {
                    msgDiv.style.opacity = '0';
                    msgDiv.style.transform = 'translateY(-10px)';
                    msgDiv.addEventListener('transitionend', () => msgDiv.remove(), { once: true });
                }
            }, 5000);
        }

        // --- NEW: API Call Functions ---

        async function fetchProducts() {
            try {
                const response = await fetch(`${BACKEND_URL}/products`);
                if (!response.ok) throw new Error('Network response was not ok');
                productOptions = await response.json();
                setupAutoComplete(productNameInput, productSuggestionsDiv, productOptions);
                productNameInput.value = productOptions[0] || '';
            } catch (error) {
                console.error('Failed to fetch products:', error);
                showMessage(predictionResultArea, 'Could not load product list from the server.', 'error');
            }
        }

        async function fetchChannels() {
            try {
                const response = await fetch(`${BACKEND_URL}/channels`);
                if (!response.ok) throw new Error('Network response was not ok');
                channelOptions = await response.json();
                setupAutoComplete(shoppingChannelInput, shoppingChannelSuggestionsDiv, channelOptions);
                shoppingChannelInput.value = channelOptions[0] || '';
            } catch (error) {
                console.error('Failed to fetch channels:', error);
                showMessage(predictionResultArea, 'Could not load channel list from the server.', 'error');
            }
        }

        async function getPrediction(inputData) {
            const payload = {
                id: "CUS" + Math.floor(Math.random() * 1000000),
                product_name: inputData.productName,
                preferred_shopping_channel: inputData.shoppingChannel,
                status: ["no"]
            };

            const response = await fetch(`${BACKEND_URL}/predict/purchase-outcome`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Prediction request failed');
            }
            return await response.json();
        }

        async function getBulkPredictions(numEntries) {
            const payload = {
                n_entries: numEntries,
                replace: true,
                date: [2024, 1, 1],
                date_entries: 50,
                max_days: 10
            };
            const response = await fetch(`${BACKEND_URL}/predict/bulk-purchase-predict`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Bulk prediction request failed');
            }
            return await response.json();
        }


        function updateSortOrderButtonIcon() {
            const iconPath = sortOrderBtn.querySelector('path');
            if (iconPath) {
                if (currentSortOrder === 'asc') {
                    iconPath.setAttribute('d', 'M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v9.75m0 0-3-3m3 3 3-3');
                } else {
                    iconPath.setAttribute('d', 'M3 19.5h14.25M3 15h9.75M3 10.5h9.75m4.5-4.5v9.75m0 0-3-3m3 3 3-3');
                }
            }
        }

        function renderPurchaseHistory() {
            historyTableBody.innerHTML = '';
            if (purchaseHistory.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">No purchases yet. Simulate one above!</td></tr>';
                metricsDashboard.classList.add('hidden');
                document.getElementById('chart-section').classList.add('hidden');
                if (outcomeChartInstance) {
                    outcomeChartInstance.destroy();
                    outcomeChartInstance = null;
                }
                return;
            }
            metricsDashboard.classList.remove('hidden');
            document.getElementById('chart-section').classList.remove('hidden');

            const sortedHistory = [...purchaseHistory].sort((a, b) => {
                let valA = a[currentSortColumn];
                let valB = b[currentSortColumn];
                if (currentSortColumn === 'time') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                }
                if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            sortedHistory.forEach(record => {
                const newRow = historyTableBody.insertRow();
                newRow.classList.add('animate-slide-in-from-bottom');
                newRow.innerHTML = `
                    <td data-label="Customer ID">${record.customerId}</td>
                    <td data-label="Time">${record.purchaseTime}</td>
                    <td data-label="Product">${record.productName}</td>
                    <td data-label="Channel">${record.shoppingChannel}</td>
                    <td data-label="Actual Outcome" class="outcome-${record.actualStatus.toLowerCase()}">${record.actualStatus}</td>
                    <td data-label="Predicted Outcome" class="outcome-${record.predictedOutcome.toLowerCase()}">${record.predictedOutcome}</td>
                `;
            });

            tableHeaders.forEach(header => {
                header.classList.remove('sorted-asc', 'sorted-desc');
                if (header.dataset.column === currentSortColumn) {
                    header.classList.add(`sorted-${currentSortOrder}`);
                }
            });

            updateMetricsDashboard();
            updateOutcomeChart();
        }

        function updateMetricsDashboard() {
            const total = purchaseHistory.length;
            if (total === 0) return;

            let correctPredictions = 0;
            const predictedCounts = { 'Keep': 0, 'Exchange': 0, 'Refund': 0 };

            purchaseHistory.forEach(record => {
                if (record.actualStatus === record.predictedOutcome) {
                    correctPredictions++;
                }
                predictedCounts[record.predictedOutcome]++;
            });

            const accuracy = (correctPredictions / total) * 100;
            const keepRate = (predictedCounts['Keep'] / total) * 100;
            const actionRate = ((predictedCounts['Exchange'] + predictedCounts['Refund']) / total) * 100;

            totalSimulationsEl.textContent = total;
            modelAccuracyEl.textContent = `${accuracy.toFixed(1)}%`;
            keepRateEl.textContent = `${keepRate.toFixed(1)}%`;
            actionRateEl.textContent = `${actionRate.toFixed(1)}%`;
        }


        function updateOutcomeChart() {
            const actualCounts = { 'Keep': 0, 'Exchange': 0, 'Refund': 0 };
            const predictedCounts = { 'Keep': 0, 'Exchange': 0, 'Refund': 0 };
            purchaseHistory.forEach(record => {
                actualCounts[record.actualStatus]++;
                predictedCounts[record.predictedOutcome]++;
            });
            const labels = ['Keep', 'Exchange', 'Refund'];
            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Actual Outcomes',
                        data: [actualCounts['Keep'], actualCounts['Exchange'], actualCounts['Refund']],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderColor: ['#065f46', '#92400e', '#991b1b'],
                        borderWidth: 1
                    },
                    {
                        label: 'Predicted Outcomes',
                        data: [predictedCounts['Keep'], predictedCounts['Exchange'], predictedCounts['Refund']],
                        backgroundColor: ['rgba(16, 185, 129, 0.5)', 'rgba(245, 158, 11, 0.5)', 'rgba(239, 68, 68, 0.5)'],
                        borderColor: ['#065f46', '#92400e', '#991b1b'],
                        borderWidth: 1
                    }
                ]
            };
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Actual vs. Predicted Purchase Outcomes', font: { size: 18, weight: 'bold', family: 'Inter, sans-serif' }, color: '#1f2937' },
                        legend: { position: 'top', labels: { font: { family: 'Inter, sans-serif' }, color: '#374151' } }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { family: 'Inter, sans-serif' }, color: '#4b5563' } },
                        y: { beginAtZero: true, ticks: { stepSize: 1, font: { family: 'Inter, sans-serif' }, color: '#4b5563' }, grid: { color: '#e5e7eb' } }
                    },
                    animation: { duration: 1000, easing: 'easeInOutQuart' }
                }
            };
            const ctx = outcomeChartCanvas.getContext('2d');
            if (outcomeChartInstance) {
                outcomeChartInstance.destroy();
            }
            outcomeChartInstance = new Chart(ctx, config);
        }

        function clearForm() {
            productNameInput.value = productOptions[0] || '';
            productSuggestionsDiv.innerHTML = '';
            productSuggestionsDiv.classList.add('hidden');
            shoppingChannelInput.value = channelOptions[0] || '';
            shoppingChannelSuggestionsDiv.innerHTML = '';
            shoppingChannelSuggestionsDiv.classList.add('hidden');
            simulateActualStatusInput.value = possibleOutcomes[0] || '';
            simulateActualStatusSuggestionsDiv.innerHTML = '';
            simulateActualStatusSuggestionsDiv.classList.add('hidden');
            predictionResultArea.innerHTML = '';
            addToHistoryBtn.classList.add('hidden');
        }

        function clearHistory() {
            purchaseHistory = [];
            renderPurchaseHistory();
            showMessage(predictionResultArea, 'Purchase history cleared.', 'info');
        }

        function setupAutoComplete(inputElement, suggestionsDiv, dataArray) {
            const renderAutoCompleteSuggestions = (filteredItems) => {
                suggestionsDiv.innerHTML = '';
                if (filteredItems.length > 0) {
                    filteredItems.forEach(item => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.textContent = item;
                        suggestionItem.addEventListener('click', () => {
                            inputElement.value = item;
                            suggestionsDiv.classList.add('hidden');
                        });
                        suggestionsDiv.appendChild(suggestionItem);
                    });
                    suggestionsDiv.classList.remove('hidden');
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
            };
            inputElement.addEventListener('input', () => {
                const searchTerm = inputElement.value.toLowerCase();
                if (searchTerm.length > 0) {
                    const filteredItems = dataArray.filter(item => item.toLowerCase().includes(searchTerm));
                    renderAutoCompleteSuggestions(filteredItems);
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
            });
            inputElement.addEventListener('focus', () => {
                if (inputElement.value.length === 0) {
                    renderAutoCompleteSuggestions(dataArray);
                }
            });
            document.addEventListener('click', (event) => {
                if (!inputElement.contains(event.target) && !suggestionsDiv.contains(event.target)) {
                    suggestionsDiv.classList.add('hidden');
                }
            });
        }

        // --- Event Listeners ---

        predictOutcomeBtn.addEventListener('click', async () => {
            const productName = productNameInput.value;
            const shoppingChannel = shoppingChannelInput.value;
            const simulateActualStatus = simulateActualStatusInput.value;

            if (productName.trim() === '' || !productOptions.includes(productName)) {
                showMessage(predictionResultArea, 'Please select a valid product from the suggestions.', 'error');
                return;
            }
            if (shoppingChannel.trim() === '' || !channelOptions.includes(shoppingChannel)) {
                showMessage(predictionResultArea, 'Please select a valid shopping channel.', 'error');
                return;
            }
            if (simulateActualStatus.trim() === '' || !possibleOutcomes.includes(simulateActualStatus)) {
                showMessage(predictionResultArea, 'Please select a valid actual status.', 'error');
                return;
            }

            predictButtonText.textContent = 'Predicting...';
            predictLoadingSpinner.classList.remove('hidden');
            predictOutcomeBtn.disabled = true;
            clearFormBtn.disabled = true;
            bulkPredictBtn.disabled = true;
            addToHistoryBtn.classList.add('hidden');
            predictionResultArea.innerHTML = '';

            try {
                let predictedOutcomeRaw = await getPrediction({ productName, shoppingChannel });
                let predictedOutcome = predictedOutcomeRaw === 'no' ? 'Keep' : predictedOutcomeRaw.charAt(0).toUpperCase() + predictedOutcomeRaw.slice(1);
                
                let actualStatusForDisplay = simulateActualStatus;

                let messageType = 'info';
                if (predictedOutcome === 'Keep') messageType = 'success';
                else if (predictedOutcome === 'Exchange') messageType = 'warning';
                else if (predictedOutcome === 'Refund') messageType = 'error';

                showMessage(predictionResultArea, `Predicted: ${predictedOutcome} (Actual: ${actualStatusForDisplay})`, messageType);
                predictOutcomeBtn.dataset.predictedOutcome = predictedOutcome;
                predictOutcomeBtn.dataset.actualStatus = actualStatusForDisplay;
                predictOutcomeBtn.dataset.productName = productName;
                predictOutcomeBtn.dataset.shoppingChannel = shoppingChannel;
                addToHistoryBtn.classList.remove('hidden');
            } catch (error) {
                console.error('Prediction error:', error);
                showMessage(predictionResultArea, `Error: ${error.message}`, 'error');
            } finally {
                predictButtonText.textContent = 'Predict Outcome';
                predictLoadingSpinner.classList.add('hidden');
                predictOutcomeBtn.disabled = false;
                clearFormBtn.disabled = false;
                bulkPredictBtn.disabled = false;
            }
        });

        clearFormBtn.addEventListener('click', clearForm);
        clearHistoryBtn.addEventListener('click', clearHistory);

        addToHistoryBtn.addEventListener('click', () => {
            const { predictedOutcome, actualStatus, productName, shoppingChannel } = predictOutcomeBtn.dataset;
            if (predictedOutcome && actualStatus && productName && shoppingChannel) {
                const newRecord = {
                    productName,
                    shoppingChannel,
                    actualStatus,
                    predictedOutcome,
                    customerId: 'CUS' + Math.floor(Math.random() * 100000),
                    purchaseTime: new Date().toLocaleString()
                };
                purchaseHistory.unshift(newRecord);
                renderPurchaseHistory();
                showMessage(predictionResultArea, 'Purchase added to history!', 'success');
                addToHistoryBtn.classList.add('hidden');
            } else {
                showMessage(predictionResultArea, 'No prediction to add. Please predict first.', 'error');
            }
        });

        startSimulatingBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = startSimulatingBtn.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                window.scrollTo({ top: targetElement.offsetTop, behavior: 'smooth' });
            }
        });

        window.addEventListener('scroll', () => {
            scrollToTopBtn.classList.toggle('show', window.scrollY > 200);
        });
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        sortColumnSelect.addEventListener('change', (e) => {
            currentSortColumn = e.target.value;
            currentSortOrder = 'asc';
            updateSortOrderButtonIcon();
            renderPurchaseHistory();
        });
        sortOrderBtn.addEventListener('click', () => {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            updateSortOrderButtonIcon();
            renderPurchaseHistory();
        });
        clearFiltersBtn.addEventListener('click', () => {
            currentSortColumn = 'time';
            currentSortOrder = 'desc';
            sortColumnSelect.value = currentSortColumn;
            updateSortOrderButtonIcon();
            renderPurchaseHistory();
            showMessage(predictionResultArea, 'Filters cleared and sorting reset.', 'info');
        });
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.dataset.column;
                if (column) {
                    if (currentSortColumn === column) {
                        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = column;
                        currentSortOrder = 'asc';
                    }
                    sortColumnSelect.value = currentSortColumn;
                    updateSortOrderButtonIcon();
                    renderPurchaseHistory();
                }
            });
        });

        // --- Bulk Predict Logic ---
        bulkPredictBtn.addEventListener('click', () => {
            bulkPredictModal.classList.add('show');
            numBulkEntriesInput.focus();
            bulkPredictMessageArea.innerHTML = '';
        });

        closeBulkModalBtn.addEventListener('click', () => {
            bulkPredictModal.classList.remove('show');
            bulkPredictMessageArea.innerHTML = '';
        });

        generateBulkBtn.addEventListener('click', async () => {
            const numEntries = parseInt(numBulkEntriesInput.value, 10);
            if (isNaN(numEntries) || numEntries <= 0 || numEntries > 100) {
                showMessage(bulkPredictMessageArea, 'Please enter a valid number between 1 and 100.', 'error');
                return;
            }

            generateBulkButtonText.textContent = 'Generating...';
            generateBulkLoadingSpinner.classList.remove('hidden');
            generateBulkBtn.disabled = true;
            closeBulkModalBtn.disabled = true;
            predictOutcomeBtn.disabled = true;
            clearFormBtn.disabled = true;
            bulkPredictBtn.disabled = true;
            bulkPredictMessageArea.innerHTML = '';

            try {
                const bulkData = await getBulkPredictions(numEntries);
                const newRecords = bulkData.map(record => {
                    let actualStatus = record.returned === 'no' ? 'Keep' : record.returned.charAt(0).toUpperCase() + record.returned.slice(1);
                    let predictedOutcome = record.predictions === 'no' ? 'Keep' : record.predictions.charAt(0).toUpperCase() + record.predictions.slice(1);
                    
                    return {
                        customerId: record.id,
                        purchaseTime: new Date(record.purchase_date).toLocaleString(),
                        productName: record.product,
                        shoppingChannel: record.Preferred_Shopping_Channels,
                        actualStatus: actualStatus,
                        predictedOutcome: predictedOutcome
                    };
                });
                purchaseHistory = newRecords.concat(purchaseHistory);
                renderPurchaseHistory();
                showMessage(bulkPredictMessageArea, `Successfully generated and added ${newRecords.length} entries.`, 'success');
                setTimeout(() => {
                    bulkPredictModal.classList.remove('show');
                    bulkPredictMessageArea.innerHTML = '';
                }, 2000);
            } catch (error) {
                console.error('Error during bulk prediction:', error);
                showMessage(bulkPredictMessageArea, `Error: ${error.message}`, 'error');
            } finally {
                generateBulkButtonText.textContent = 'Generate & Add to History';
                generateBulkLoadingSpinner.classList.add('hidden');
                generateBulkBtn.disabled = false;
                closeBulkModalBtn.disabled = false;
                predictOutcomeBtn.disabled = false;
                clearFormBtn.disabled = false;
                bulkPredictBtn.disabled = false;
            }
        });

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchProducts();
            await fetchChannels();
            setupAutoComplete(simulateActualStatusInput, simulateActualStatusSuggestionsDiv, possibleOutcomes);
            simulateActualStatusInput.value = possibleOutcomes[0] || '';
            clearForm();
            updateSortOrderButtonIcon();
            renderPurchaseHistory();
        });
    </script>
</body>
</html>
